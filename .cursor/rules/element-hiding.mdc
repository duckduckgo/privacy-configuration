---
globs: features/element-hiding.json,overrides/**/*.json
alwaysApply: false
description: Element hiding mitigation decision guide and rule type reference for privacy-configuration. Use this when working with element-hiding rules and mitigations.
---
# Element Hiding Mitigation Rules

## Schema & Configuration References

- **Schema**: `schema/features/element-hiding.ts` - TypeScript type definitions
- **Configuration**: `features/element-hiding.json` - Rule definitions and domain-specific overrides

## Type Definitions

```typescript
// Hide rules (no values field allowed)
type ElementHidingRuleHide = {
  selector: string;
  type: 'hide-empty' | 'hide' | 'closest-empty' | 'override';
  // No values field allowed for hide rules
}

// Modify rules (values field required)
type ElementHidingRuleModify = {
  selector: string;
  type: 'modify-style' | 'modify-attr';
  values: ElementHidingValue[];  // Required for modify rules
}

// Disable rules (no selector field allowed)
type ElementHidingRuleDisable = {
  type: 'disable-default';
}

type ElementHidingRule = ElementHidingRuleHide | ElementHidingRuleModify | ElementHidingRuleDisable;

type ElementHidingValue = {
  property: string;
  value: string;
}

type ElementHidingDomain = {
  domain: string | string[];
  rules: ElementHidingRule[];
}
```

## Element Hiding Mitigation Decision Tree (Strategy-Prioritized):

```
Blank spaces? → hide-empty (try first)
↓
Target has content but parent empty? → closest-empty
↓
Content must be hidden? → hide (only if necessary — may trigger detection)
↓
Global rule conflict? → override the selector
↓
Adblock detection? → disable-default + add working rules
↓
Layout/visual issues? → modify-style
↓
Attribute issues? → modify-attr
```

## Rule Type Reference

| Rule Type | Use Case | Values Field | Notes |
|-----------|----------|--------------|-------|
| `hide-empty` | Empty ad containers or blank placeholders | ❌ **Forbidden** | ✅ Default rule. Hides only if empty. |
| `closest-empty` | Empty parent container remains | ❌ **Forbidden** | Crawls up DOM tree to hide the empty parent. |
| `hide` | Always hide, even if visible content | ❌ **Forbidden** | ⚠️ Use sparingly — can cause detection. |
| `override` | Cancel specific global rules | ❌ **Forbidden** | Domain-specific only. Fixes global breakage. |
| `disable-default` | Defuse adblock detection | ❌ **Forbidden** | Domain-specific only. Never alone; rebuild safe rules. |
| `modify-style` | Layout or visibility tweaks | ✅ **Required** | Replace CSS values (e.g., height → 0px). |
| `modify-attr` | Attribute corrections | ✅ **Required** | Replace element attributes (e.g., src/class). |

### Configuration Structure
- **Rule Placement**: 
- **Domain-specific rules**: Go in `domains[]` array
- **Global rules**: Go in top-level `rules[]` array
- **Global settings**: `useStrictHideStyleTag`, `hideTimeouts`, `unhideTimeouts`
- **Media selectors**: `mediaAndFormSelectors` for form/media element targeting
- **Ad labels**: `adLabelStrings` for identifying ad containers
- **Exceptions**: `styleTagExceptions` for domains with special handling

## Error Reporting Format

When validation fails, provide clear, actionable error messages:

```
❌ **Element Hiding Validation Error**
**File**: `features/element-hiding.json`
**Location**: `domains[0].rules[0]`
**Error**: Missing required field 'selector' for rule type 'hide-empty'
**Fix**: Add `"selector": ".your-selector"` to the rule
```

### Common Error Scenarios

```
❌ **Missing Selector Field**
**Error**: Rule type 'hide-empty' requires 'selector' field
**Fix**: Add `"selector": ".ad-container"` to the rule
```

```
❌ **Invalid Rule Type**
**Error**: 'hide-forever' is not a valid rule type
**Valid types**: hide-empty, hide, closest-empty, override, modify-style, modify-attr, disable-default
**Fix**: Use one of the valid rule types
```

```
❌ **Missing Values Array**
**Error**: Rule type 'modify-style' requires 'values' array
**Fix**: Add `"values": [{"property": "display", "value": "none"}]` to the rule
```

```
❌ **Forbidden Values Field**
**Error**: Rule type 'hide-empty' cannot have 'values' field
**Fix**: Remove the 'values' field from the rule
```

```
❌ **Wrong Rule Placement**
**Error**: Global rule placed in domain-specific section
**Fix**: Move rule to global 'rules[]' array or add 'domain' field to make it domain-specific
```
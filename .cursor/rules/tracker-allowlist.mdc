---
globs: features/tracker-allowlist.json,overrides/**/*.json
alwaysApply: false
---

# Tracker Allowlist Mitigation Instructions

## Background

Tracker Allowlist is used to allow specific tracker requests that would normally be blocked by the tracker radar, where necessary to fix website breakages. The feature configuration lists rules of which tracker requests should be allowed for which websites. Care must be taken when writing these rules, since allowing tracker requests reduces privacy protection for users.

See:
- [Tracker Allowlist rule definitions](/features/tracker-allowlist.json)
  (Applies to all browser platforms.)
- [Platform-specific configuration override files](/overrides/)
- [The schema for tracker allowlist rules](/schema/features/tracker-allowlist.ts)
- [Bugbot PR review guidelines](/cursor/BUGBOT.md)

## Table of Contents

- [Quick Cheat Sheet](#quick-cheat-sheet)
  - [Tracker Allowlist Decision Tree](#tracker-allowlist-decision-tree-strategy-prioritized)
  - [Reference Tracker Rule Set](#reference-tracker-rule-set)
- [Site Mitigation Triager In-Depth Guideline](#site-mitigation-triager-in-depth-guideline)
  - [1. Choosing Trackers to Allow](#1-choosing-trackers-to-allow)
    - [1.1. Not too generic nor too specific](#11-not-too-generic-nor-too-specific)
    - [1.2. Avoid regex/wildcards](#12-avoid-regexwildcards)
  - [2. Rule Precedence (Ordering)](#2-rule-precedence-ordering)
    - [2.1. How the Matching Algorithm Works: First Match Wins Principle](#21-how-the-matching-algorithm-works-first-match-wins-principle)
    - [2.2. Rule Specificity and Ordering: when order matters vs. doesn't matter](#22-rule-specificity-and-ordering-when-order-matters-vs-doesnt-matter)
    - [2.3. Domain Propagation: when duplicating domain is required](#23-domain-propagation-when-duplicating-domain-is-required)
    - [2.4. The `<all>` Specifier: essential considerations](#24-the-all-specifier-essential-considerations)
  - [4. Cross-Entity Coverage](#4-cross-entity-coverage)
  - [5. Domain-Wide Exceptions](#5-domain-wide-exceptions)

## Quick Cheat Sheet

### Tracker Allowlist Decision Tree (Strategy-Prioritized):


1. Search existing rules first for both the domain you're mitigating and the rule you have in mind (including platform overrides)
   - see [1. Choosing Trackers to Allow](#1-choosing-trackers-to-allow)
↓
2. Rule already exists? → Update domains/reason if needed. When updating, follow step 6 guidance.
↓
3. Rule doesn't exist? → Make sure your new rule is specific but stable
   - Example: "tracker.com/api/endpoint" (Avoid domain-only rules and dynamic params like user/session IDs, tokens, timestamps)
   - see [1.1. Not too generic nor too specific](#11-not-too-generic-nor-too-specific) 
↓
4. Check if the new rule shares prefix with existing rules
   - Example: "tracker.com/api/endpoint" shares prefix with "tracker.com/api", but not with "sub.tracker.com/api/endpoint"
   - see [2.2. Rule Specificity and Ordering](#22-rule-specificity-and-ordering-when-order-matters-vs-doesnt-matter)
↓
5. It shares prefix? → Order most-specific → least-specific
   - Example: "tracker.com/api/endpoint" comes before "tracker.com/api"
   - see [2.2. Rule Specificity and Ordering](#22-rule-specificity-and-ordering-when-order-matters-vs-doesnt-matter)
   - Should this apply to all domains? Use `<all>` if appropriate and see [2.4. The `<all>` Specifier](#24-the-all-specifier-essential-considerations)
↓
6. Add the site domain to all rules that share the same prefix
   - Example: If you add "site.com" to "tracker.com/api", also add it to any more-specific rule such as "tracker.com/api/endpoint"
   - see [2.3. Domain Propagation](#23-domain-propagation-when-duplicating-domain-is-required) 
   - Should this apply to all domains? Use `<all>` if appropriate (domain propagation not needed when using `<all>`) see [2.4. The `<all>` Specifier](#24-the-all-specifier-essential-considerations)
↓
7. Multi-country/sibling sites might be affected? → Consider cross-entity coverage
   - see [4. Cross-Entity Coverage](#4-cross-entity-coverage)
↓
8. Domain-wide exception needed? → Avoid if possible; document thoroughly if required
   - see [5. Domain-Wide Exceptions](#5-domain-wide-exceptions)


### Reference Tracker Rule Set

```json
"tracker.com": {
  "rules": [
    {
      "rule": "tracker.com/static/widget.js/config/analytics",  // Most specific first
      "domains": [
        "site1.com",
        "site3.com" // Add site3.com so domain propagation can work
      ],
      "reason": [
        "site1.com - https://github.com/duckduckgo/privacy-configuration/pull/1111",
        "site3.com - https://github.com/duckduckgo/privacy-configuration/pull/3333"
      ]
    },
    {
      "rule": "tracker.com/static/widget.js/config",  // Less specific, shares prefix, the original tracker intended to allow on site3.com
      "domains": [
        "site3.com"
      ],
      "reason": [
        "site3.com - https://github.com/duckduckgo/privacy-configuration/pull/3333"
      ]
    },
    {
      "rule": "tracker.com/static/widget.js",  // Least specific, shares prefix
      "domains": [
        "<all>" // no need to add specific domain, <all> covers all domains
      ],
      "reason": "https://github.com/duckduckgo/privacy-configuration/pull/4444"
    },
    {
      "rule": "tracker.com/api/collect",  // Different prefix, order doesn't matter
      "domains": [
        "site2.com"
      ],
      "reason": "site2.com - https://github.com/duckduckgo/privacy-configuration/pull/2222"
    }
  ]
}
```

## Site Mitigation Triager In-Depth Guideline

### 1. Choosing Trackers to Allow

### 1.1. Not too generic nor too specific
- Avoid domain-only rules (no path): `"rule": "tracker.com"`
- Avoid temporary URLs with dynamic parameters (eg. user or session IDs, tokens, timestamps)
- Use specific, stable endpoint paths: `"rule": "tracker.com/api/endpoint"`

### 1.2. Avoid regex/wildcards
This is because platforms have varying support for these.

✅ **Examples of Suitable Specific Paths:**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/scripts/main.js",  // Specific file
        "domains": ["site1.com"],
        "reason": [
          "site1.com - https://github.com/duckduckgo/privacy-configuration/issues/1111"
          ]
      },
      {
        "rule": "tracker.com/api/analytics",  // Specific API endpoint
        "domains": ["site2.com"],
        "reason": "site2.com - https://github.com/duckduckgo/privacy-configuration/pull/2222"
      }
    ]
  }
}
```

### 2. Rule Precedence (Ordering)

**Critical:** Order rules **most‑specific → least‑specific,** but **only** when both can match the same tracker request. Rules must share a prefix: `foo.com/bar` is a prefix of `foo.com/bar/baz`.

### 2.1. How the Matching Algorithm Works: First Match Wins Principle

The algorithm follows a "first match wins" principle: it checks rules from top to bottom and stops at the first matching rule.

1. **Check rules from top to bottom** until a rule matches the request URL.
2. **When a rule matches:**
   - If the current site domain is in the rule's `domains` list → allowlist applies (request is **not blocked**)
   - If the rule's `domains` list contains `<all>` → allowlist applies (request is **not blocked**)
   - Otherwise → allowlist does not apply (request is **blocked**)
3. **The algorithm stops** at the first match and uses that rule's domain list (subsequent rules are ignored).

**Example:**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/analytics", // Most specific first
        "domains": ["site1.com"],
        "reason": ["site1.com - https://github.com/duckduckgo/privacy-configuration/issues/1111"]
      },
      {
        "rule": "tracker.com/api", // Less specific second
        "domains": ["<all>"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/pull/2222"
      }
    ]
  }
}
```

- `tracker.com/api/analytics` on `site1.com`: Matches first rule → `site1.com` in list → **allowed**
- `tracker.com/api/other` on any site: Doesn't match first rule, matches second rule → `<all>` applies → **allowed** 

### 2.2. Rule Specificity and Ordering: when order matters vs. doesn't matter

Order matters only if two rules could match the same tracker request. The more specific rule must be listed first. This prevents a broad rule from "catching" a request before the rule that was meant for it.

A rule is more specific if:
- it uses a subdomain (e.g., `www.example.com` is more specific than `example.com`)
- or it has a longer path (e.g., `example.com/foo/bar` is more specific than `example.com/foo`)

If two rules can't match the same tracker request then their order does not matter:
- `sub.example.com` vs `api.example.com` are different domains
- `example.com/foo` vs `example.com/bar` don't share a prefix - one path is not a prefix of the other

**Example - Correct Ordering of same tracker request:**

```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/analytics/main.js",  // Most specific first
        "domains": ["site1.com"],
        "reason": ["site1.com - https://github.com/duckduckgo/privacy-configuration/issues/1111"]
      },
      {
        "rule": "tracker.com/api/analytics",  // Less specific second
        "domains": ["site2.com"],
        "reason": "site2.com - https://github.com/duckduckgo/privacy-configuration/pull/2222"
      },
      {
        "rule": "tracker.com/api",  // Least specific last
        "domains": ["site3.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/pull/3333"
      }
    ]
  }
}
```

### 2.3. Domain Propagation: when duplicating domain is required

For same trackers requests only, a domain in a less-specific rule, must also appear in all more-specific rules.

This applies the "first match wins" principle. If a request matches a more-specific rule first, but the domain isn't in that rule's list, the request will be blocked, even if the domain is in a less-specific rule below it. This prevents a broad rule from "catching" a request before the rule that was meant for it.

**Example (without propagation - broken):**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/specific",  // More specific (checked first)
        "domains": ["site1.com"]  // Missing site2.com
      },
      {
        "rule": "tracker.com/api",
        "domains": ["site2.com"]
      }
    ]
  }
}
```

**Problem:** `tracker.com/api` isn't allowed on `site2.com` as intended. Although `site2.com` is listed in the less specific rule (`tracker.com/api`), there's a more specific rule (`tracker.com/api/specific`) that doesn't include `site2.com`, which blocks the request.

**Example (with propagation - fixed):**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/specific",  // More specific rule
        "domains": ["site1.com", "site2.com"]  // site2.com added (propagation will work)
      },
      {
        "rule": "tracker.com/api",  // Less specific rule (original intention for site2.com)
        "domains": ["site2.com"]
      }
    ]
  }
}
```

**Fixed:** Unlike the previous example, `site2.com` is now in the more specific rule's domain list. As a result, `tracker.com/api` is now **allowed** on `site2.com` as intended ✓.

**Note**: Domain propagation is only needed when both rules have specific domain lists (no `<all>`; because it already covers all domain)

### 2.4. The `<all>` Specifier: essential considerations

The `<all>` specifier is treated as if every domain were specified in the list. This means a rule with `<all>` will allow the request for any site domain.

**Example 1: More-specific rule has a site domain, less-specific rule has <all>**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/analytics", // only allowed on site1.com
        "domains": ["site1.com"],
        "reason": ["site1.com - https://github.com/duckduckgo/privacy-configuration/issues/1111"]
      },
      {
        "rule": "tracker.com/api", // allowed on all domains
        "domains": ["<all>"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/pull/2222"
      }
    ]
  }
}
```
**Key insight:** The first rule restricts the `analytics` path to `site1.com` only, while the second rule with `<all>` acts as a catch-all for other paths:
- Anything under `tracker.com/api/analytics/*` is restricted to `site1.com` only (matches first rule)
- Anything under `tracker.com/api/*` that doesn't start with `analytics` is allowed on all domains (matches second rule with `<all>`)
- Consequently, `tracker.com/api/analytics` from `any-other-site.com` matches the first rule, but the domain is not in that rule's list → **blocked** ✗

**Example 2: More-specific rule has <all>, less-specific rule has a site domain**

```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/specific", // allowed on all domains
        "domains": ["<all>"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/pull/3333"
      },
      {
        "rule": "tracker.com/api", // only allowed on site1.com
        "domains": ["site1.com"],
        "reason": ["site1.com - https://github.com/duckduckgo/privacy-configuration/issues/4444"]
      }
    ]
  }
}
```

**Key insight:** The more-specific rule with `<all>` allows all domains for that path, while the less-specific rule restricts other paths to specific domains:
- Anything under `tracker.com/api/specific/*` is **allowed on all domains** (matches first rule with `<all>`)
- Anything under `tracker.com/api/*` that doesn't start with `specific` is restricted to `site1.com` only (matches second rule)
- When any site requests `tracker.com/api/specific`, it matches the first rule → `<all>` applies, request is **allowed** ✓

**Important:** Make sure the more-specific rule comes first. If the less-specific rule comes first, requests to `tracker.com/api/specific` will match the less-specific rule first and be blocked for domains not in that rule's list, preventing the more-specific rule with `<all>` from being reached.

### 4. Cross-Entity Coverage

- **Multi-country brands:** Consider adding mitigations across country sites (e.g., `vinted.com`, `vinted.fr`, `vinted.de`)

- **Sibling sites under same parent company:** Check if breakage exists, then consider adding coverage across a business group

### 5. Domain-Wide Exceptions

A domain-wide exception is added to the `"exceptions"` array of the JSON file. This allows all tracker requests from that domain without restriction, which is why it should be avoided.
**Avoid whenever possible.** If you must add one, make sure your PR clearly explains the reason, including whether this is part of a speculative mitigation experiment.
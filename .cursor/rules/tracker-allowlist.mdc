---
globs: features/tracker-allowlist.json,overrides/**/*.json
alwaysApply: false
---

# Tracker Allowlist Mitigation Instructions

## Background

Tracker Allowlist is used to allow specific tracker requests that would normally be blocked by the tracker radar, where necessary to fix website breakages. The feature configuration lists rules of which tracker requests should be allowed for which websites. Care must be taken when writing these rules, since allowing tracker requests reduces privacy protection for users.

See:
- [Tracker Allowlist rule definitions](/features/tracker-allowlist.json)
  (Applies to all browser platforms.)
- [Platform-specific configuration override files](/overrides/)
- [The schema for tracker allowlist rules](/schema/features/tracker-allowlist.ts)
- [Bugbot PR review guidelines](/cursor/BUGBOT.md)


✅ **Examples of Suitable Specific Paths:**
```json
{
  "tracker.com": {
    "rules": [
      {
        "rule": "tracker.com/api/analytics",  // ✅ Specific API endpoint
        "domains": ["site.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/issues/123"
      },
      {
        "rule": "tracker.com/api/scripts/main.js",  // ✅ Specific file
        "domains": ["site.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/issues/456"
      }
    ]
  }
}
```

2.3. **avoid regex/wildcards**

### 3. Rule Precedence (Ordering)

3.1. **Critical:** Order rules **most‑specific → least‑specific,** but **only** when both can match the same request. Same-host prefix matching is required: foo.com/bar is a prefix of foo.com/bar/baz.

Ordering does not matter for different hosts (they never match). For example, www.example.com/foo ≠ example.com/foo ≠ cdn.example.com/foo.

**Example - Correct Ordering:**


```json
{
  "example.com": {
    "rules": [
      {
        "rule": "example.com/foo/bar/baz",  // ✅ Most specific first
        "domains": ["site1.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/issues/123"
      },
      {
        "rule": "example.com/foo/bar",  // ✅ Less specific second
        "domains": ["site2.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/issues/456"
      },
      {
        "rule": "example.com",  // ✅ Least specific last
        "domains": ["site3.com"],
        "reason": "https://github.com/duckduckgo/privacy-configuration/issues/789"
      }
    ]
  }
}
```

3.2. **Adding domains to less-specific rules:**

Add the domain to both the more-specific and less-specific rules.
**Why?** The first matching rule is checked. If a request matches a more-specific rule but the domain isn't in that rule's list, it blocks.

```json
{
  "rule": "example.com/foo/bar/baz",  // More specific
  "domains": ["site1.com", "site2.com"]  // ✅ Add site2.com here too
},
{
  "rule": "example.com/foo/bar",  // Less specific
  "domains": ["site2.com"]  // ✅ Added here
}
```

### 4. Cross-Entity Coverage

- **Multi-country brands:** Consider adding mitigations across country sites (e.g., `vinted.com`, `vinted.fr`, `vinted.de`)

- **Sibling sites under same parent company:** Check if breakage exists, then consider adding coverage across a business group

### 5. Domain-Wide Exceptions

**Avoid whenever possible.** If you must add one, make sure your PR clearly explains the reason, including whether this is part of a speculative mitigation experiment

## See Also

- **Schema**: `schema/features/tracker-allowlist.ts` - TypeScript definitions
- **BUGBOT**: `.cursor/BUGBOT.md` - PR review guidelines
